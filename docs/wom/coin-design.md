# Wolf of Minestreet — 종목 등급 시스템 + 코인 설계

> **주식과 코인 모두 같은 PriceEngine 위에서 동작.**
> **등급(AssetGrade)이 변동성, 캡, 평균회귀, 이벤트 편향 등 모든 파라미터를 결정.**
> **레버리지 없음. 현물 매수 + 게임적 강제 청산 룰.**

---

## 종목 등급 (AssetGrade)

모든 종목(주식 + 코인)은 하나의 등급을 가진다.
등급이 곧 그 종목의 성격.

| 등급            | 타입 | σ (변동성) | 캡         | 평균회귀     | VI       | 이벤트 편향      | 청산     | 예시                                    |
| --------------- | ---- | ---------- | ---------- | ------------ | -------- | ---------------- | -------- | --------------------------------------- |
| **BLUECHIP**    | 주식 | 0.02~0.03  | ±2%        | 강함 (0.015) | 있음     | 중립 (펌프=덤프) | 없음     | 나유타, 정글, 테라코어, 메종 오렐리우스 |
| **GROWTH**      | 주식 | 0.035~0.05 | ±2%        | 보통 (0.01)  | 있음     | 약간 상승 편향   | 없음     | 볼트 모터스, 헤르메스 페이, 제트닷컴    |
| **SPECULATIVE** | 주식 | 0.05~0.07  | ±3% (넓음) | 약함 (0.005) | 있음     | 중립~약간 하락   | 없음     | 헬릭스, 루나 에스테이트, 팝콘 픽쳐스    |
| **COIN**        | 코인 | 0.10~0.15  | **없음**   | **없음**     | **없음** | 하락 편향        | **있음** | 일반 코인                               |
| **MEMECOIN**    | 코인 | 0.15~0.25  | **없음**   | **없음**     | **없음** | 강한 하락 편향   | **있음** | 밈코인 (빠른 사망)                      |

### 등급별 이벤트 확률 비율

**주식 (안정적)**:
| 등급        | 호재 | 악재 | 비율 | 성격                     |
| ----------- | ---- | ---- | ---- | ------------------------ |
| BLUECHIP    | 5%   | 5%   | 5:5  | 중립, 이벤트가 방향 결정 |
| GROWTH      | 6%   | 4%   | 6:4  | 약간 상승 편향           |
| SPECULATIVE | 4%   | 5%   | 4:5  | 약간 하락, 가끔 대박     |

**코인 (야수의 심장)**:
| 등급     | 펌프 | 덤프 | 문샷 | 러그풀 | 비율    | 성격                      |
| -------- | ---- | ---- | ---- | ------ | ------- | ------------------------- |
| COIN     | 3%   | 7%   | 1%   | 0.2%   | **3:7** | 자주 맞지만, 한 방이 큼   |
| MEMECOIN | 3%   | 7%   | 2%   | 0.5%   | **3:7** | 더 자주 맞고, 더 큰 한 방 |

**코인 이벤트 크기 비대칭** (핵심):
```
덤프: 자주 옴, 작은 타격      -10% ~ -30%    ███████ 70%
펌프: 가끔 옴, 중간 수익      +10% ~ +50%    ███ 25%
문샷: 극히 드묾, 인생역전      +50% ~ +200%   █ ~5%
러그풀: 극히 드묾, 즉사        → 상장폐지      (0.2~0.5%)
```

> **컨셉: 7번 맞고 3번 때리는데, 3번이 치명타.**
> drift 없음. 이벤트 비대칭 + 평균회귀 부재로 자연스러운 하락 편향.
> 그러나 문샷 한 방이면 손실 전부 복구 + 대박 가능.
> 존버는 강제 청산 때문에 불가 → 순수 타이밍 싸움.

---

## 가격 공식 (통합)

```
r_gbm = σ * Z                          (Z = 정규분포 난수)
r_mr  = mr_strength * ln(MA20 / P)     (평균회귀, 등급별 강도)
r_base = clamp(r_gbm + r_mr, ±cap)     (등급별 캡, 코인은 캡 없음)
r_event = 이벤트 점프                   (등급별 캡 적용 여부)
r = r_base + r_event
P_next = P * exp(r)
```

### 등급별 파라미터

| 파라미터    | BLUECHIP | GROWTH  | SPECULATIVE   | COIN        | MEMECOIN    |
| ----------- | -------- | ------- | ------------- | ----------- | ----------- |
| cap_base    | ±0.02    | ±0.02   | ±0.03         | 없음 (±999) | 없음 (±999) |
| cap_event   | tier별   | tier별  | tier별 (넓게) | 없음        | 없음        |
| mr_strength | 0.015    | 0.01    | 0.005         | 0           | 0           |
| VI          | 8% 이탈  | 8% 이탈 | 10% 이탈      | 없음        | 없음        |
| floor_price | 1.0      | 1.0     | 1.0           | 0.01        | 0.01        |

---

## 기존 30종목 등급 배정

| 등급        | 종목                                                                                                                                                                                               |
| ----------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| BLUECHIP    | 테라코어(TCOR), 나유타(NAYU), 정글(JNGL), 에테르나(ETRN), 메종 오렐리우스(MAUR), 바질(BSLE), 제니스 로직(ZNTH), 실리콘 다이내믹스(SILD), 엘리트라 항공(ELTR), 광협(KWOP)                           |
| GROWTH      | 매머드(MMTH), 볼트 모터스(BOLT), 헤르메스 페이(HRMS), 임페리움(IMPR), 제트닷컴(ZJET), 크라켄 수산(KRKN), 파지직(FZJK), 니지컬러즈(NIJI), 부루마불(BRMB), 스카이 캐슬(SKYC), 바이스 앤 크로네(WSKR) |
| SPECULATIVE | 크란츠 앤 밀러(KNM), 아르고 라인(ARGO), 헬릭스(HELX), 판다 F&B(PNDA), 로얄 버거(RYLB), 올웨이즈24(AW24), 팝콘 픽쳐스(POPC), 루나 에스테이트(LUNA)                                                  |

---

## 코인 전용 시스템

### 코인 생명주기

#### 1단계: 탄생 (Listing)
- 새 코인 상장 → 서버 전체 공지
- 초기 가격: 1.0~10.0 (저가)
- 상장 직후 3분간 펌프 이벤트 확률 2배 (초기 투자 유도)
- "§d[신규 상장] XX코인 거래 시작! 초기 가격 {가격}원"

#### 2단계: 일반 거래 (Trading)
- 이벤트 비대칭으로 장기 하락 압력
- 펌프 터지면 반등, 안 터지면 서서히 하락
- 변동성이 극단적이라 단기 트레이딩 가능

#### 3단계: 사망 (Delisting)
- 가격 0.01 이하 → 상장폐지
- 또는 러그풀 이벤트 → 즉시 사망
- 남은 보유자 강제 청산

#### 4단계: 교체 (Replacement)
- 상장폐지 후 5분 뒤 새 코인 자동 생성
- 항상 **5개** 활성 코인 유지

### 코인 이벤트 유형

#### 덤프 이벤트 (7할 — 자주, 작게)
- "XX코인, 개발자 물량 대량 매도"
- "XX코인, 보안 취약점 발견"
- "XX코인, 규제 당국 조사 착수"
- "XX코인, 고래 지갑 대량 매도 포착"
- "XX코인, 텔레그램 커뮤니티 와해"
- "XX코인, 거래소 지갑 해킹 의혹"
- "XX코인, 경쟁 코인에 기술력 밀려"
- 점프: **-10%~-30%** (캡 없음)
- 확률: **7%/틱**

#### 펌프 이벤트 (2.5할 — 가끔, 크게)
- "XX코인, 유명 인플루언서 추천!"
- "XX코인, 대형 거래소 상장 루머"
- "XX코인, 기술 업데이트 발표"
- "XX코인, 고래 지갑 대량 매집 포착"
- "XX코인, 유명 기업 결제 수단 채택설"
- 점프: **+10%~+50%** (캡 없음)
- 확률: **3%/틱**

#### 문샷 이벤트 (한 방 — 극히 드묾, 인생역전)
- "XX코인, 나유타 시스템즈 공식 채택!"
- "XX코인, 정부 디지털 화폐 기반 기술 선정"
- "XX코인, 글로벌 결제망 편입 확정"
- 점프: **+50%~+200%** (캡 없음)
- 확률: COIN **1%/틱**, MEMECOIN **2%/틱**

#### 러그풀 이벤트 (즉사)
- "XX코인, 개발팀 잠적 — 러그풀 확정"
- "XX코인, 스마트 컨트랙트 백도어 발견"
- 가격 즉시 0.01 이하 → 상장폐지 트리거
- 확률: COIN **0.2%/틱**, MEMECOIN **0.5%/틱**

### 코인 풀 관리

#### 활성 코인 수: 5개
- COIN 등급 3개 + MEMECOIN 등급 2개

#### 코인 이름 풀 (사전 정의, 랜덤 선택)
- 문코인, 다이아코인, 레드스톤코인, 네더코인, 엔더코인
- 도지캐슬, 크리퍼캐시, 위더토큰, 좀비골드, 팬텀페이
- 개구리코인, 판다토큰, 드래곤캐시, 피닉스토큰, 슬라임코인
- 블레이즈코인, 가스트코인, 셜커토큰, 엔더진주, 네더스타

#### 코인 스탯 (등급에 따라 범위 내 랜덤)
|            | COIN      | MEMECOIN  |
| ---------- | --------- | --------- |
| basePrice  | 3.0~10.0  | 1.0~3.0   |
| volatility | 0.10~0.15 | 0.15~0.25 |

---

## 청산 시스템 (2단계, 코인 전용)

> **레버리지 없음. 현물 매수 + 게임적 강제 청산 룰.**
> 레버리지 도입 시 서버 경제 파괴 가능성 → 채택하지 않음.

### 1단계: 주기적 청산 (강제 손절)

> 매수 평균가 대비 현재가가 -50% 이하 → 강제 매도.
> 현물이지만 코인은 "존버 금지" 룰이 붙는다.

#### 메커니즘
- **청산 체크 주기**: 매 틱 (10초)마다 전체 코인 보유자 스캔
- **청산 기준**: 현재가 ≤ 매수 평균가 × **0.5** (50% 하락 시 강제 청산)
  - 예: 10원에 매수 → 가격이 5원 이하가 되면 즉시 강제 매도
- **청산 가격**: 강제 매도 시점의 현재가 (잔금 돌려받음)
- **부분 청산 없음**: 해당 코인 보유분 전량 강제 매도
- **주식은 해당 없음**: 주식(BLUECHIP/GROWTH/SPECULATIVE)은 청산 대상 아님

#### 필요 데이터
- **매수 평균가 추적**: 플레이어별, 코인별 매수 평균가 기록
  - 추가 매수 시 가중평균으로 갱신
  - `avgBuyPrice = (기존수량 × 기존평균가 + 추가수량 × 매수가) / 총수량`
- PortfolioManager에 `avgBuyPrice: Map<String, Map<String, Double>>` 추가
  - `playerUUID → stockId → 평균 매수가`

#### 처리 순서
1. 틱마다 모든 코인 보유자의 평가손익 체크
2. 현재가 / 평균매수가 ≤ 0.5 인 경우:
   - 보유분 전량을 현재가에 강제 매도
   - 매도 대금은 플레이어에게 지급 (0원은 아님, 남은 가치만큼 돌려받음)
   - 플레이어 메시지: `§c[청산] XX코인 -50% 돌파 — {수량}개 강제 매도 ({매도금액}원 지급)`
   - 서버 공지: `§c[청산] {플레이어}님의 XX코인 포지션 강제 청산`
3. 평균매수가 기록 삭제

#### 존버 방지 효과
- 10원에 산 코인이 5원 되면 → 강제 매도 (5원 돌려받음)
- 다시 사고 싶으면 5원에 새로 매수해야 함 → 평균가 리셋
- 즉, 하락장에서 물타기해도 평균가 낮아지면 또 잘림
- "언젠간 오르겠지" 존버 전략 무효화

---

### 2단계: 상장폐지 (Delisting)

> 코인 가격이 **0.01 이하**로 떨어지면 상장폐지. 남은 보유자 전원 **0원 처리**.

#### 트리거
- 코인 현재가 ≤ 0.01
- 또는 러그풀 이벤트 발동

#### 처리 순서
1. 해당 코인 거래 즉시 중단 (매수/매도 불가)
2. 남은 보유자의 포지션 전량 0원 처리 (돈 안 돌려줌)
3. 포트폴리오에서 해당 코인 보유량 + 평균매수가 삭제
4. 보유자 개별 메시지: `§4[상장폐지] XX코인 사망 — {수량}개 전액 손실`
5. 서버 공지: `§4§l[상장폐지] XX코인 사망! 피해자 {N}명, 총 피해 {금액}원`
6. 피해 금액 TOP 3 발표 (불명예의 전당)
7. 5분 후 새 코인으로 교체

#### 상폐 vs 주기적 청산
|             | 주기적 청산               | 상장폐지              |
| ----------- | ------------------------- | --------------------- |
| 트리거      | 개인 평균가 대비 -50%     | 코인 절대가 0.01 이하 |
| 대상        | 해당 플레이어만           | 전원                  |
| 돌려받는 돈 | 현재가 × 수량 (일부 회수) | **0원** (전액 손실)   |
| 코인 존속   | 계속 거래 가능            | 영구 폐지             |

---

## 시나리오 예시

```
[틱 1] 문코인 상장! 가격: 5.0원 (MEMECOIN)
  → A가 100개 매수 (평균가 5.0, 투자금 500원)
  → B가 200개 매수 (평균가 5.0, 투자금 1000원)

[틱 3] 펌프! "문코인, 인플루언서 추천!" → 가격: 8.2원
  → A, B 모두 수익 중 (+64%)

[틱 8] 덤프! "문코인, 고래 대량 매도" → 가격: 3.5원
  → A: 보유 중 (3.5 / 5.0 = 0.70, 아직 안전)
  → C가 50개 매수 (평균가 3.5)

[틱 12] 추가 하락 → 가격: 2.4원
  → A 청산! (2.4 / 5.0 = 0.48 < 0.5) → 100개 강제 매도, 240원 지급 (260원 손실)
  → B 청산! (2.4 / 5.0 = 0.48 < 0.5) → 200개 강제 매도, 480원 지급 (520원 손실)
  → C는 안전 (2.4 / 3.5 = 0.69)

[틱 15] 소폭 반등 → 가격: 3.1원
  → C 수익 중 (-11%), 다시 살아날까?

[틱 20] 러그풀! "문코인, 개발팀 잠적!" → 가격: 0.001원
  → 상장폐지! C의 50개 → 0원 처리 (175원 손실)
  → 서버 공지: "문코인 사망! 피해자 1명, 총 피해 175원"
  → 서버 공지: "5분 후 새 코인 상장 예정..."

[틱 50] 드래곤캐시 상장! 가격: 7.0원 (COIN)
```

---

## 데이터 구조 변경

### AssetGrade enum (새 파일)
```kotlin
enum class AssetGrade(
    val capBase: Double,      // 틱당 base 캡 (999 = 없음)
    val mrStrength: Double,   // 평균회귀 강도
    val viEnabled: Boolean,   // VI 적용 여부
    val floorPrice: Double,   // 최저가
    val liquidation: Boolean  // 강제 청산 대상 여부
) {
    BLUECHIP   (0.02,  0.015, true,  1.0,  false),
    GROWTH     (0.02,  0.01,  true,  1.0,  false),
    SPECULATIVE(0.03,  0.005, true,  1.0,  false),
    COIN       (999.0, 0.0,   false, 0.01, true),
    MEMECOIN   (999.0, 0.0,   false, 0.01, true)
}
```

### Stock 모델
```kotlin
data class Stock(
    val id: String,
    val name: String,
    val symbol: String,
    var currentPrice: Double,
    val basePrice: Double,
    val category: String = "기타",
    val volatility: Double = 0.05,
    var totalVolume: Long = 0,
    val grade: AssetGrade = AssetGrade.GROWTH  // 추가
)
```

### PriceEngine 변경
```
computeReturn(stock, ma, eventJump, rng):
  grade = stock.grade
  rGbm = σ * Z
  rMr = grade.mrStrength * ln(MA20 / P)      // 코인은 0
  rBase = clamp(rGbm + rMr, ±grade.capBase)   // 코인은 캡 없음
  rEvent = eventJump                           // 코인은 이벤트 캡도 없음
  return rBase + rEvent

checkVI(stock, ...):
  if (!stock.grade.viEnabled) return           // 코인은 스킵

tick():
  ...기존 로직...
  checkLiquidation()                           // 코인 청산 체크 추가
  checkDelist()                                // 코인 상폐 체크 추가
```

### 새 파일
- `model/AssetGrade.kt` — 등급 enum
- `engine/CoinManager.kt` — 코인 생명주기 (상장/폐지/교체/청산 체크)

### 수정 파일
- `model/Stock.kt` — grade 필드 추가
- `engine/PriceEngine.kt` — 등급 기반 분기
- `engine/EventLoader.kt` — coins/ 폴더 스캔 + grade 파싱
- `manager/PortfolioManager.kt` — avgBuyPrice 추적
- `command/WomCommand.kt` — 코인 구분 표시, /wom coins

---

## 구현 시 주의사항

### 1. 매도 시 평균매수가 불변
- **매수**: 가중평균으로 평균가 갱신
- **매도**: 수량만 줄임, 평균가 안 바뀜
- **전량 매도/청산**: 평균가 데이터 삭제
- 이거 안 지키면 청산 기준이 꼬임

### 2. 청산 알림 스팸 방지
- 급락 시 다수 플레이어 동시 청산 가능
- 개별 메시지는 각자에게 보내되, 서버 공지는 모아서 한 줄로:
  - `§c[대량 청산] XX코인 폭락 — {N}명 청산, 총 {금액}원 증발`
- 틱당 청산 공지는 최대 1회로 제한

### 3. 오프라인 청산 처리
- 플레이어가 접속 안 한 상태에서 청산/상폐 가능
- 청산 내역을 저장해두고, 접속 시 알림:
  - `§c[알림] 부재 중 XX코인에서 청산당했습니다. ({수량}개 → {금액}원 지급)`
  - `§4[알림] 부재 중 XX코인이 상장폐지되었습니다. ({수량}개 전액 손실)`
- `pendingNotifications: Map<UUID, List<String>>` 저장 → PlayerJoinEvent에서 발송

### 4. 코인 이름 생성기
- 고정 풀 대신 prefix + suffix 랜덤 조합으로 무한 생성
- prefix: 문, 도지, 페페, 시바, 엘론, 로켓, 다이아, 골드, 실버, 네더, 엔더, 크리퍼, 위더, 드래곤, 피닉스, 슬라임, 블레이즈, 팬텀, 좀비, 해골
- suffix: 코인, 토큰, 캐시, 체인, 스왑, 파이, 문, 스타

---

## 커맨드

### 주식 (기존)
- `/wom list` — 주식 목록만
- `/wom buy/sell <종목> <수량>` — 주식/코인 공용
- `/wom info <종목>` — 종목 상세
- `/wom portfolio` — 보유 현황 (주식/코인 모두)
- `/wom news` — 최근 뉴스

### 코인 (신규)
- `/wom coins` — 활성 코인 목록 (가격, 등급, 생존 시간)
- `/wom coin info <코인>` — 코인 상세 + 내 평균매수가 + 청산 기준가

### 웹 대시보드
- 주식/코인 별도 페이지로 분리

---

## 구현 우선순위

1. `model/AssetGrade.kt` — 등급 enum 생성
2. `model/Stock.kt` — grade 필드 추가
3. `engine/PriceEngine.kt` — 등급 기반 분기 (캡/VI/평균회귀/floor)
4. `manager/PortfolioManager.kt` — avgBuyPrice 추적 + 매도 시 불변 로직
5. `engine/CoinManager.kt` — 코인 생명주기 + 청산 + 상폐 + 이름 생성기
6. `engine/EventLoader.kt` — coins/ 폴더 + grade 파싱
7. 기존 30종목 YAML에 grade 필드 추가
8. 코인 이벤트 템플릿 YAML 작성
9. `command/WomCommand.kt` — /wom coins, 청산 알림
10. 오프라인 청산 알림 (PlayerJoinEvent)
11. 빌드 + 테스트
